# Tên file: .github/workflows/main.yml
name: CI/CD for Spring Boot Application (Local Docker)

on:
  push:
    branches:
      - main # Chạy workflow khi có push lên nhánh 'main'
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted # Chạy trên VPS Linux của bạn

    env:
      # Các biến môi trường lấy từ GitHub Secrets.
      IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      DOCKER_HOST_PORT: 9020 # Cổng trên máy host
      APP_INTERNAL_PORT: 8080 # Cổng mà ứng dụng Spring Boot lắng nghe bên trong container

      # Biến môi trường cho ứng dụng Spring Boot
      FRONTEND_RESET_PASSWORD_URL: ${{ secrets.FRONTEND_RESET_PASSWORD_URL }}
      FRONTEND_VERIFY_EMAIL_URL: ${{ secrets.FRONTEND_VERIFY_EMAIL_URL }}
      PAYOS_RETURN_URL: ${{ secrets.PAYOS_RETURN_URL }}
      PAYOS_CANCEL_URL: ${{ secrets.PAYOS_CANCEL_URL }}
      GOOGLE_GEMINI_PROJECT_ID: ${{ secrets.GOOGLE_GEMINI_PROJECT_ID }}
      GOOGLE_GEMINI_LOCATION: ${{ secrets.GOOGLE_GEMINI_LOCATION }}
      GOOGLE_GEMINI_MODEL_NAME: ${{ secrets.GOOGLE_GEMINI_MODEL_NAME }}
      # GOOGLE_CREDENTIALS_JSON sẽ được xử lý riêng bên dưới

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Kéo mã nguồn về runner

      - name: Build Docker Image
        run: |
          echo "Building Docker image ${IMAGE_NAME}:latest from Dockerfile..."
          docker build -t $IMAGE_NAME:latest .
          echo "Docker image built successfully: ${IMAGE_NAME}:latest"

      - name: Stop and Remove Old Container (if exists)
        run: |
          echo "Stopping and removing existing container ${IMAGE_NAME}..."
          docker stop $IMAGE_NAME || true
          docker rm $IMAGE_NAME || true
          echo "Old container stopped and removed (if it existed)."

      # ***** BƯỚC SỬA LỖI - PHƯƠNG ÁN 2: TRUYỀN THẲNG BASE64 ENV *****
      - name: Run Docker Container (Inject Environment Variables)
        run: |
          echo "Running new Docker container ${IMAGE_NAME}..."
          
          # 1: KHÔNG tạo file JSON nữa.
          
          # 2: Lệnh docker run (Định dạng multi-line đã loại bỏ các dòng trống)
          # Truyền thẳng secret (đang là Base64) vào biến môi trường GOOGLE_CREDENTIALS_BASE64
          docker run -d \
            --name $IMAGE_NAME \
            -p $DOCKER_HOST_PORT:$APP_INTERNAL_PORT \
            -e GOOGLE_CREDENTIALS_BASE64="${{ secrets.GOOGLE_CREDENTIALS_JSON }}" \
            -e FRONTEND_RESET_PASSWORD_URL=${{ secrets.FRONTEND_RESET_PASSWORD_URL }} \
            -e FRONTEND_VERIFY_EMAIL_URL=${{ secrets.FRONTEND_VERIFY_EMAIL_URL }} \
            -e PAYOS_RETURN_URL=${{ secrets.PAYOS_RETURN_URL }} \
            -e PAYOS_CANCEL_URL=${{ secrets.PAYOS_CANCEL_URL }} \
            -e GOOGLE_GEMINI_PROJECT_ID=${{ secrets.GOOGLE_GEMINI_PROJECT_ID }} \
            -e GOOGLE_GEMINI_LOCATION=${{ secrets.GOOGLE_GEMINI_LOCATION }} \
            -e GOOGLE_GEMINI_MODEL_NAME=${{ secrets.GOOGLE_GEMINI_MODEL_NAME }} \
            $IMAGE_NAME:latest
          
          # 3: KHÔNG cần xóa file
          
          echo "New Docker container started successfully, mapped to host port $DOCKER_HOST_PORT."

      - name: Check Running Container Status
        run: |
          echo "Checking status of container ${IMAGE_NAME}..."
          # Đợi một chút để container có thời gian khởi động
          sleep 10
          docker ps -f "name=${IMAGE_NAME}"

      - name: Show container logs
        run: |
          echo "=== Reading container logs (stdout/stderr) ==="
          # Thêm 'docker logs' để xem output của container, rất hữu ích khi debug
          # Lỗi MalformedJsonException sẽ xuất hiện ở đây
          docker logs $IMAGE_NAME
          
          echo "=== Reading app.log from container (if available) ==="
          # Chờ thêm vài giây để ứng dụng có thể đã bắt đầu ghi log
          sleep 5
          docker exec $IMAGE_NAME cat /app/logs/app.log || echo "Log file /app/logs/app.log not found or container not ready."
