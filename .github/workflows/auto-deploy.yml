name: CI/CD for Spring Boot Application (Local Docker)

on:
  push:
    branches:
      - main # Chạy workflow khi có push lên nhánh 'master' (hoặc 'main')
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted # Chạy trên VPS Linux của bạn

    env:
      # Các biến môi trường lấy từ GitHub Secrets.
      # Đảm bảo bạn đã cấu hình các secrets này trong repo của mình.
      IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      # Tên image Docker (ví dụ: healthcare-app)
      DOCKER_HOST_PORT: 9020 # Cổng trên máy host (ví dụ: 80)
      APP_INTERNAL_PORT: 8080 # Cổng mà ứng dụng Spring Boot lắng nghe bên trong container (thường là 8080)

      # Nếu ứng dụng Spring Boot của bạn cần các biến môi trường cấu hình, hãy thêm vào đây
      # Ví dụ:
      # DATABASE_URL: ${{ secrets.DATABASE_URL }}
      # API_KEY: ${{ secrets.API_KEY }}
      FRONTEND_RESET_PASSWORD_URL: ${{ secrets.FRONTEND_RESET_PASSWORD_URL }}
      FRONTEND_VERIFY_EMAIL_URL: ${{ secrets.FRONTEND_VERIFY_EMAIL_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Kéo mã nguồn về runner (trên VPS của bạn)

      - name: Build Docker Image
        run: |
          echo "Building Docker image ${IMAGE_NAME}:latest from Dockerfile..."
          # Lệnh này sẽ chạy Docker build. Docker sẽ đọc Dockerfile của bạn,
          # thực hiện multi-stage build (build Maven JAR, copy vào JRE image)
          # và tạo ra image cuối cùng.
          docker build -t $IMAGE_NAME:latest .
          echo "Docker image built successfully: ${IMAGE_NAME}:latest"

      - name: Stop and Remove Old Container (if exists)
        run: |
          echo "Stopping and removing existing container ${IMAGE_NAME}..."
          docker stop $IMAGE_NAME || true
          docker rm $IMAGE_NAME || true
          echo "Old container stopped and removed (if it existed)."

      # ***** BƯỚC CŨ ĐÃ BỊ THAY THẾ BẰNG BƯỚC MỚI NÀY *****
      - name: Run Docker Container (Inject Environment Variables)
        run: |
          echo "Running new Docker container ${IMAGE_NAME}..."
          
          # 1: Tạo file credentials tạm thời trên máy runner
          # Nó lấy nội dung từ GitHub Secret GOOGLE_CREDENTIALS_JSON
          echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > ./gemini-creds.json
          echo "Temporary credentials file created."
          
          # 2: Sửa lệnh docker run
          docker run -d \
            --name $IMAGE_NAME \
            -p $DOCKER_HOST_PORT:$APP_INTERNAL_PORT \
            \
            # Mount file credentials từ runner vào BÊN TRONG container
            -v $(pwd)/gemini-creds.json:/app/creds.json \
            \
            # Đây chính là biến môi trường ADC
            -e GOOGLE_APPLICATION_CREDENTIALS=/app/creds.json \
            \
            # Các biến cũ của bạn (giữ nguyên)
            -e FRONTEND_RESET_PASSWORD_URL=${{ secrets.FRONTEND_RESET_PASSWORD_URL }} \
            -e FRONTEND_VERIFY_EMAIL_URL=${{ secrets.FRONTEND_VERIFY_EMAIL_URL }} \
            -e PAYOS_RETURN_URL=${{ secrets.PAYOS_RETURN_URL }} \
            -e PAYOS_CANCEL_URL=${{ secrets.PAYOS_CANCEL_URL }} \
            \
            # Thêm các biến cấu hình Gemini (đọc từ secret bạn tạo ở Bước 3)
            -e GOOGLE_GEMINI_PROJECT_ID=${{ secrets.GOOGLE_GEMINI_PROJECT_ID }} \
            -e GOOGLE_GEMINI_LOCATION=${{ secrets.GOOGLE_GEMINI_LOCATION }} \
            -e GOOGLE_GEMINI_MODEL_NAME=${{ secrets.GOOGLE_GEMINI_MODEL_NAME }} \
            $IMAGE_NAME:latest
          
          # 3: Xóa file credentials trên máy runner cho an toàn
          rm ./gemini-creds.json
          echo "Temporary credentials file removed."
          
          echo "New Docker container started successfully, mapped to host port $DOCKER_HOST_PORT."

      - name: Check Running Container Status
        run: |
          echo "Checking status of container ${IMAGE_NAME}..."
          docker ps -f "name=${IMAGE_NAME}"
      - name: Show container logs
        run: |
          echo "=== Reading app.log from container ==="
          docker exec $IMAGE_NAME cat /app/logs/app.log || true
